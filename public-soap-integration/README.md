# Техническое описание API операций Cash-In Cash-Out

Данный материал предназначен для демонстрации сценариев интеграции платёжной системы (ПС) AllPay. Содержит описание сценариев взаимодействия и описание протоколов.

### СОДЕРЖАНИЕ

1. [ЦЕЛЬ](#ЦЕЛЬ)
1. [СЦЕНАРИЙ СНЯТИЯ](#СЦЕНАРИЙ-СНЯТИЯ)
1. [СЦЕНАРИЙ ПОПОЛНЕНИЯ](#СЦЕНАРИЙ-ПОПОЛНЕНИЯ)
1. [ПРИНЦИПЫ ВЗАИМОДЕЙСТВИЯ С ПС ALLPAY](#ПРИНЦИПЫ-ВЗАИМОДЕЙСТВИЯ-С-ПС-ALLPAY)
1. [ОПИСАНИЕ ФОРМАТА СООБЩЕНИЙ](#ОПИСАНИЕ-ФОРМАТА-СООБЩЕНИЙ)
 2. [WesbshopRequest](#webshoprequest)
 2. [WebshopResponse](#webshopresponse)
1. [ТЕХНИЧЕСКИЕ ДЕТАЛИ ВЗАИМОДЕЙСТВИЯ](#ТЕХНИЧЕСКИЕ-ДЕТАЛИ-ВЗАИМОДЕЙСТВИЯ)
1. [СЕРВИСЫ МАНИПУЛИРОВАНИЯ ТРАНЗАКЦИЯМИ](#СЕРВИСЫ-МАНИПУЛИРОВАНИЯ-ТРАНЗАКЦИЯМИ)
2. [ИСПОЛЬЗОВАНИЕ ТЕСТОВОЙ СИСТЕМЫ ALLPAY](#ИСПОЛЬЗОВАНИЕ-ТЕСТВОЙ-СИСТЕМЫ-ALLPAY)
2. [ПРИМЕРЫ ДЕМО РЕАЛИЗАЦИЙ](#ПРИМЕРЫ-РЕАЛИЗАЦИЙ)
 3. [НА ЯЗЫКЕ JAVA](#РЕАЛИЗАЦИЯ-НА-ЯЗЫКЕ-java)

### ЦЕЛЬ
Сервисы предназначены для того, чтобы дать возможность осуществлять операции «Снятие» и «Пополнение» через платёжную систему Allpay.

### СЦЕНАРИЙ СНЯТИЯ

1. Клиент просит кассира Снять деньги с кошелька allpay
1. Клиент формирует "токен" в приложении allpay. Клиент передает токен и логин кошелька allpay Кассиру
2. Кассир формирует запрос на Снятие, используя токен и логин. Кассир отправляет запрос на сервер allpay
3. Кассир получает уведомление об успешной транзакции
4. Клиент получает пуш уведомление об успешной транзакции
4. Кассир передает наличные деньги Клиенту

### СЦЕНАРИЙ ПОПОЛНЕНИЯ

1. Клиент просит кассира Пополнить деньги на кошелёк allpay
2. Клиент передает наличные и логин кошелька allpay Кассиру
2. Кассир формирует запрос на Пополнение кошелька, используя логин Клиента. Кассир отправляет запрос на сервер allpay
3. Кассир получает уведомление об успешной транзакции
4. Клиент получает пуш уведомление об успешной транзакции


### ПРИНЦИПЫ ВЗАИМОДЕЙСТВИЯ С ПС ALLPAY

Для обмена данными используется формат XML, для всех видов передаваемых сообщений определена [соответствующая схема XSD](http://allpay.kz/xsd/1.0.0/).
Для безопасного обмена сообщениями все XML подписываются обеими сторонами. Подпись реализована по стандарту W3C описанными в XSD схеме XmlDSig.
Каждое сообщение должно проходить валидацию по соответствующей XSD схеме, все обязательные поля должны быть заполнены по формату.

Используемая кодировка – UTF-8.

В большинстве схем обмена данными присутствуют общие поля. Все общие поля описаны схемой [OnlineTransactionCommons.xsd](http://allpay.kz/xsd/1.0.0/OnlineTransactionCommons.xsd).
Далее приведено описание и назначения каждого из общих полей.

`language` — язык текстов. От него зависит на каком языке будут приходить тексты ошибок, статусов или других текстовых описаний.

`userName` — логин пользователя в системе Allpay. 

`amount` — сумма денег указанная в KZT

`commission` — Содержит комиссию на транзакцию

`transactionInfo` — Содержит информацию о транзакции:
 * `GUID` — уникальный идентификатор транзакции на стороне пользователя API
 * `amount` — сумма в KZT
 * `transactionId` — идентификатор транзакции
 * `transactionStatus` — статус транзакции
 * `commission` — комиссия на транзакцию

`onlineTransactionResponseHeader` — общее поле для всех ответов на запросы. Содержит:
 * `userMessage` — поле информативного характера. Обычно это сообщения, которое можно показать пользователю. Содержит описание ошибок, статусов и т.д.
 * `developerMessage` — поле информативного характера. Содержит техническое описание и коды ошибок.
 * `status` — Статус запроса. Описание статусов будет приведено ниже.
 * `timestamp` — дата ответа
 * `token` - токен

`transactionResponse` — содержит информацию о транзакции.
 * `header` — составное поле типа onlineTransactionResponseHeader
 * `transactionInfo` — составное поле типа transactionInfo

`onlineTransactionRequestHeader` — общее поле для всех запросов. Содержит:
 * `lang` — определяет язык. Поле типа language, описанного выше.
 * `timestamp` — дата отправки запроса.
 * `requester` — логин отправителя в системе Allpay.
